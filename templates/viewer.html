<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Viewer reportů – přehled</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        html, body { height: 100%; }
        body { margin: 0; }

        .hero { position: relative; width: 100%; min-height: 100vh; overflow: hidden; }
        .hero object { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .hero .container { position: relative; z-index: 1; padding-top: 5rem; padding-bottom: 5rem; }

        .card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.25); box-shadow: 0 0 60px rgba(0,0,0,0.08); }

        .table thead th { position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); z-index: 2; }

        .filename { font-weight: 600; }
        .muted { color: #6c757d; }

        .badge-ext { font-weight: 500; }
    </style>
</head>
<body>


<nav class="navbar navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
        <ul class="navbar-nav flex-row gap-4">
            <li class="nav-item">
                <a id="navHome" class="nav-link d-flex align-items-center fw-semibold" href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                         class="bi bi-house-door-fill me-2" viewBox="0 0 16 16">
                        <path d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5"/>
                    </svg>
                    Domů
                </a>
            </li>
            <li class="nav-item">
                <a id="navReports" class="nav-link d-flex align-items-center fw-semibold" href="#">
                    <i class="bi bi-graph-up me-2"></i>
                    Reporty
                </a>
            </li>
        </ul>
    </div>
</nav>

<script>
    (function () {
        // /Dokladujto-reports/... ← vezmeme 1. segment cesty jako "repo"
        const segs = location.pathname.split('/').filter(Boolean);
        const basePath = segs.length ? `/${segs[0]}` : '';
        document.getElementById('navHome').href    = `${basePath}/index.html`;
        document.getElementById('navReports').href = `${basePath}/templates/cross.html`;
    })();
</script>

<section class="hero">
    <object type="image/svg+xml" data="background.svg"></object>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card p-4 rounded-4">
                    <h1 class="h3 fw-bold mb-3">Dostupné reporty</h1>
                    <div class="muted mb-4">Přehled reportů s datem.</div>

                    <div class="table-responsive rounded-3">
                        <table class="table align-middle mb-0">
                            <thead>
                            <tr>
                                <th style="width: 60%">Název</th>
                                <th style="width: 20%">Datum</th>
                                <th class="text-end" style="width: 20%">Akce</th>
                            </tr>
                            </thead>
                            <tbody id="report-tbody">
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">Načítám…</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="empty-state" class="text-center d-none py-5">
                        <i class="bi bi-inboxes fs-1 d-block mb-2"></i>
                        <p class="mb-0">Žádné reporty pro tuto sekci.</p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<script>
    (function() {
        const params = new URLSearchParams(window.location.search);
        const modul = params.get('modul');
        const typ   = params.get('typ');

        const tbody = document.getElementById('report-tbody');
        const empty = document.getElementById('empty-state');

        const basePath = window.location.pathname.split('/')[1];

        const csDate = new Intl.DateTimeFormat('cs-CZ', { dateStyle: 'medium', timeStyle: 'short' });

        function humanizeName(filename) {
            const name = filename.replace(/\.[^.]+$/, '');
            return name.replace(/[._-]+/g, ' ');
        }

        function parseDateFromString(str) {
            let m = str.match(/(20\d{2})[._-]?(\d{2})[._-]?(\d{2})(?:[ T_-]?(\d{2})[._-]?(\d{2})(?:[._-]?(\d{2}))?)?/);
            if (m) {
                const [ , y, mo, d, h='00', mi='00', se='00'] = m;
                const iso = `${y}-${mo}-${d}T${h}:${mi}:${se}`;
                const dt = new Date(iso);
                if (!isNaN(dt)) return dt;
            }
            m = str.match(/\b(\d{1,2})\.(\d{1,2})\.(20\d{2})(?:[ _-](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
            if (m) {
                const [ , d, mo, y, h='00', mi='00', se='00'] = m;
                const pad = n => String(n).padStart(2,'0');
                const iso = `${y}-${pad(mo)}-${pad(d)}T${pad(h)}:${pad(mi)}:${pad(se)}`;
                const dt = new Date(iso);
                if (!isNaN(dt)) return dt;
            }
            return null;
        }

        function fileExt(filename) {
            const m = filename.match(/\.([^.]+)$/);
            return m ? m[1].toLowerCase() : '';
        }

        // Jednoduchý CSV parser (uvozovky, čárky)
        function parseCSV(text) {
            const lines = text.split('\n');
            const rows = [];
            for (let line of lines) {
                if (line == null) continue;
                line = line.replace(/\r$/, '');
                const cells = [];
                let cur = '', inQ = false;
                for (let i=0;i<line.length;i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQ && line[i+1] === '"') { cur += '"'; i++; }
                        else inQ = !inQ;
                    } else if (ch === ',' && !inQ) {
                        cells.push(cur); cur='';
                    } else {
                        cur += ch;
                    }
                }
                if (cur !== '' || line.endsWith(',')) cells.push(cur);
                if (cells.length) rows.push(cells.map(c => c.trim().replace(/^"|"$/g,'')));
            }
            const header = (rows.shift()||[]).map(h => h.toLowerCase());
            return { header, rows };
        }

        function makeRow(entry) {
            const tr = document.createElement('tr');
            const readerPath = `/${basePath}/report-reader.html?modul=${modul}&typ=${typ}&file=${encodeURIComponent(entry.filename)}`;

            tr.innerHTML = `
      <td>
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-file-earmark"></i>
          <div>
            <div class="filename">${entry.title}</div>
            <div class="small muted filename-meta">
              <span class="file-name">${entry.filename}</span>
              <span class="badge text-bg-light badge-ext ms-1">.${entry.ext}</span>
            </div>
            ${entry.ext === 'csv' ? `
              <div class="small mt-1">
                <span class="counts text-nowrap">
                  <span class="text-success">✔ <span class="cnt-p">…</span></span>
                  <span class="text-danger ms-2">✖ <span class="cnt-f">…</span></span>
                  <span class="text-secondary ms-2">? <span class="cnt-u">…</span></span>
                </span>
                <div class="csv-note text-muted mt-1"></div>
              </div>
            ` : ''}
          </div>
        </div>
      </td>
      <td>
        ${entry.date ? `<span title="${entry.date.toISOString()}">${csDate.format(entry.date)}</span>` : '<span class="text-muted">nezjištěno</span>'}
      </td>
      <td class="text-end">
        <a href="${readerPath}" class="btn btn-sm btn-primary"><i class="bi bi-eye"></i> Zobrazit</a>
      </td>`;

            // Pokud je CSV, spočítáme souhrn a načteme volitelný popisek
            if (entry.ext === 'csv') {
                const url = `/${basePath}/reports/${modul}/${typ}/${encodeURIComponent(entry.filename)}`;
                const cntP = tr.querySelector('.cnt-p');
                const cntF = tr.querySelector('.cnt-f');
                const cntU = tr.querySelector('.cnt-u');
                const note = tr.querySelector('.csv-note');

                fetch(url)
                    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
                    .then(text => {
                        // Případné úvodní komentáře začínající '#'
                        const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l => l.trim() !== '');
                        let leadingNote = '';
                        while (lines.length && /^\s*#/.test(lines[0])) {
                            const ln = lines.shift().replace(/^\s*#\s?/, '');
                            leadingNote += (leadingNote ? ' ' : '') + ln.trim();
                        }
                        if (leadingNote && note) note.textContent = leadingNote;

                        const csvText = lines.join('\n');
                        const { header, rows } = parseCSV(csvText);
                        const idx = header.findIndex(h => h === 'status');
                        let p=0,f=0,u=0;
                        if (idx !== -1) {
                            for (const row of rows) {
                                const v = (row[idx]||'').toLowerCase();
                                if (['passed','pass','ok','success','true','1'].includes(v)) p++;
                                else if (['failed','fail','error','false','0'].includes(v)) f++;
                                else u++;
                            }
                        }
                        if (cntP) cntP.textContent = p;
                        if (cntF) cntF.textContent = f;
                        if (cntU) cntU.textContent = u;
                    })
                    .catch(() => {
                        if (cntP) cntP.textContent = '0';
                        if (cntF) cntF.textContent = '0';
                        if (cntU) cntU.textContent = '0';
                    });
            }

            return tr;
        }

        function render(list) {
            tbody.innerHTML = '';
            if (!list.length) {
                empty.classList.remove('d-none');
                return;
            }
            empty.classList.add('d-none');
            list.forEach(entry => tbody.appendChild(makeRow(entry)));
        }

        fetch('../reports.json')
            .then(res => res.json())
            .then(data => {
                const list = (data?.[modul]?.[typ]) || [];

                const entries = list.map(fn => {
                    const date = parseDateFromString(fn);
                    const ext = fileExt(fn);
                    return {
                        filename: fn,
                        title: humanizeName(fn),
                        date,
                        ext
                    };
                });

                entries.sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));

                render(entries);
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="3" class="text-danger">Chyba při načítání seznamu: ${err.message}</td></tr>`;
                console.error('Chyba při načítání reportů:', err);
            });
    })();
</script>
</body>
</html>
